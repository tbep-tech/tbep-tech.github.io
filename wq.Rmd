---
title: "Get EPCHC Data, Tidy it Up & Perform TBEP Annual WQ Assessment"
author: "Ed Sherwood <esherwood@tbep.org>, Ben Best <ben@ecoquants.com>"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    code_folding: hide
    toc: yes
    toc_float: yes
---

Original: [esherwoo77/pull_epc_data:pull_epc_data.Rmd](https://github.com/esherwoo77/pull_epc_data/blob/master/pull_epc_data.Rmd)

```{r setup, include=FALSE}
# libraries
require(tidyverse)
require(lubridate)
require(readxl)
require(curl)
require(leaflet)
require(rmarkdown)
require(here) # gets consistent path based on *.Rproj
require(glue) # easy string creation
library(tools)
library(gt)
#library(tbeptools)
devtools::load_all('../tbeptools/.')
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)

# variables
download_latest_epchc <- FALSE

# paths
# here(): set path based on root of repo where *.Rproj is found
epchc_xlsx    <- here("data-raw/epchc.xlsx")
epcdata_rdata <- here("data-raw/epcdata.RData")

# set Google Drive folder to where sync'd
user <- Sys.info()[["user"]]
dir_gdrive <- case_when(
  user == "Marcus" ~ "C:/Users/Marcus.SCCWRP2K/Google Drive/tbep-tech",
  user == "bbest" ~ "/Users/bbest/Gdrive Ecoquants/projects/tbep-tech")

# test paths
test_xlsx <- file.path(dir_gdrive, "data/wq/2018_Results_Updated.xls")
stopifnot(file.exists(test_xlsx))
```

## TODO

- Shiny app:
  - slider to change thresholds and see results

## Code to Download EPCHC Dataset
```{r epchc_download}
#library(tbeptools)
#get_epchc_wq(epchc_xlsx)

#URL of EPCHC's long-term dataset in Excel Spreadsheet format
epchc_url <- "ftp://ftp.epchc.org/EPC_ERM_FTP/WQM_Reports/RWMDataSpreadsheet_ThroughCurrentReportMonth.xlsx"

if (!file.exists(epchc_xlsx) | download_latest_epchc){
  # download data from EPCHC's ftp site
  tmp_xlsx <- tempfile(fileext = "xlsx")
  download.file(url = epchc_url, destfile = tmp_xlsx, method = "libcurl", mode = "wb") # 23.2 MB
  
  is_latest <- md5sum(epchc_xlsx) == md5sum(tmp_xlsx)
  if (!is_latest){
    file.copy(tmp_xlsx, epchc_xlsx, overwrite=T)
  }
}

# TODO: for Travis updating: if (is_latest) return() # no need to update
```

## Download and import EPCHC dataset

```{r epchc_import}
# load data and some light formatting
epcdata <- load_epchc_wq(test_xlsx, download_latest_epchc = F)
epcdata
```


```{r ecphc_validate}
#Display station locations
wqsites <- frmdat(epcdata) %>% 
           select(epchc_station, Latitude, Longitude) %>% 
           unique()                                                   

map <- leaflet(wqsites) %>%                                         
              addProviderTiles(providers$CartoDB.Positron) %>% 
              addCircleMarkers(~Longitude, ~Latitude,
                               radius = 6,
                               color = 'black',
                               stroke = FALSE,
                               opacity = 0.8,
                               popup = ~as.character(paste('EPC Station:', epchc_station)), 
                               group = 'Water quality') %>% 
              addLayersControl(overlayGroups = c('Water quality'),
                               options = layersControlOptions(collapsed = FALSE))
map
```

## Plot Mean Annual Chl-a Values by Bay Segment {.tabset}

### Old Tampa Bay

```{r chlplot_otb}
thrplot(epcdata, bay_segment = "OTB", thr = "chla")
```

### Hillsborough Bay

```{r chlplot_hb}
thrplot(epcdata, bay_segment = "HB", thr = "chla")
```

### Middle Tampa Bay

```{r chlplot_mtb}
thrplot(epcdata, bay_segment = "MTB", thr = "chla")
```

### Lower Tampa Bay

```{r chlplot_ltb}
thrplot(epcdata, bay_segment = "LTB", thr = "chla")
```

## Plot Mean Annual Light Attenuation Values by Bay Segment {.tabset}

### Old Tampa Bay

```{r laplot_otb}
thrplot(epcdata, bay_segment = "OTB", thr = "la")
```

### Hillsborough Bay

```{r laplot_hb}
thrplot(epcdata, bay_segment = "HB", thr = "la")
```

### Middle Tampa Bay

```{r laplot_mtb}
thrplot(epcdata, bay_segment = "MTB", thr = "la")
```

### Lower Tampa Bay

```{r laplot_ltb}
thrplot(epcdata, bay_segment = "LTB", thr = "la")
```

#### NEED TO USE THE FILES BELOW TO GENERATE THE COLOR CODED TABLE OF RESULTS

## Export Annual Values as a Tidy CSV File
Export final datasets to csv files in 'data-processed' folder.
```{r epchc_export_tidy_data}
# write.csv(chladata, file = "./data-processed/TB_Chla_Annual_Means.csv")
# write.csv(chlamodata, file = "./data-processed/TB_Chla_Monthly_means.csv")
# write.csv(sdmdata, file = "./data-processed/TB_Secchi_Annual_Means.csv")
# write.csv(sdmmodata, file = "./data-processed/TB_Secchi_Monthly_means.csv")
```

## Colorized Table

Now let's produce a color coded table similar to that found in [tbep-tech:data/wq/TBEP_01_19_2018_**Decision_Matrix_Update**.pdf](https://drive.google.com/open?id=1NGq0VzaPv1_uxgoDkprVTAndSuBygSuq)
  
![](img/decision-matrix_color-table-snip.png)

except we'll include the actual values and color code cells along a gradient using the new [**gt**](https://github.com/rstudio/gt) R package.

```{r}
colorize_fld <- function(gtbl, fld, pal=c("red", "yellow", "green"), digits=1){
  gtbl %>% 
    data_color(
      #columns = vars(fld), 
      columns = fld, 
      colors = scales::col_numeric(
        palette = pal,
        domain =  gtbl[[fld]])) %>% 
    fmt_number(
      #columns = vars(fld),
      columns = fld,
      decimals = 1) 
}

colorize_tbl <- function(gtbl, exclude_cols="Year", pal=c("red", "yellow", "green"), digits=1){
  flds <- setdiff(names(gtbl), exclude_cols)
  for (fld in flds){
    gtbl <- colorize_fld(gtbl, fld, pal, digits)
  }
  gtbl
}

read_csv(here("data-processed/TB_Chla_Annual_Means.csv")) %>% 
  select(-X1) %>% 
  #View()
  spread(bay_segment, mean_chla) %>% 
  rename(Year=yr) %>% #,
  gt() %>% 
  colorize_tbl()
```
